rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is a teacher
    function isTeacher() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }
    
    // Helper function to check if user is an admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is teacher or admin
    function isTeacherOrAdmin() {
      return isTeacher() || isAdmin();
    }
    
    // Users collection
    match /users/{uid} {
      // User can read their own profile, admins can read all profiles
      allow read: if isAuthenticated() && (request.auth.uid == uid || isAdmin());
      
      // Create: user may create own doc but cannot set role (admins can set role)
      allow create: if isAuthenticated() && 
                      (request.auth.uid == uid && !('role' in request.resource.data)) ||
                      isAdmin();

      // Update: user may update own doc but role must remain unchanged (admins can update anything)
      allow update: if isAuthenticated() && 
                      ((request.auth.uid == uid && 
                        resource != null &&
                        request.resource.data.role == resource.data.role) ||
                       isAdmin());

      // Delete: user may delete own doc, admins can delete any
      allow delete: if isAuthenticated() && (request.auth.uid == uid || isAdmin());
      
      // Role is readable by authenticated users (for rule checks)
      // Role cannot be written by users themselves
      
      // Tasks subcollection
      match /tasks/{taskId} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
        allow write: if isAuthenticated() && request.auth.uid == uid;
      }
      
      // Achievements subcollection
      match /achievements/{achievementId} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
        allow write: if isAuthenticated() && request.auth.uid == uid;
      }
      
      // Notifications subcollection
      match /notifications/{notifId} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
        allow write: if isAuthenticated() && request.auth.uid == uid;
      }
      
      // Inventory subcollection (items owned by user)
      match /inventory/{itemId} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
        allow write: if isAuthenticated() && request.auth.uid == uid;
      }
      
      // Lootboxes subcollection (lootbox opening history)
      match /lootboxes/{lootboxId} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
        allow write: if isAuthenticated() && request.auth.uid == uid;
      }
      
      // Battle history subcollection
      match /battleHistory/{battleId} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
        allow write: if isAuthenticated() && request.auth.uid == uid;
      }
    }
    
    // Courses collection
    match /courses/{courseId} {
      // All authenticated users can read courses
      allow read: if isAuthenticated();
      
      // Only teachers or admins can write courses
      allow write: if isTeacherOrAdmin();
    }
    
    // Tasks collection (top-level, not user-specific)
    match /tasks/{taskId} {
      // All authenticated users can read tasks
      allow read: if isAuthenticated();
      
      // Only teachers or admins can write tasks
      allow write: if isTeacherOrAdmin();
    }
    
    // Task progress collection
    match /taskProgress/{uid} {
      // User can only read/write their own progress
      allow read, write: if isAuthenticated() && request.auth.uid == uid;
    }
    
    // Achievements collection
    match /achievements/{achievementId} {
      // All authenticated users can read achievements
      allow read: if isAuthenticated();
      
      // Only admins can write achievements
      allow write: if isAdmin();
    }
    
    // Achievement progress collection
    match /achievementProgress/{uid} {
      // User can only read/write their own progress
      allow read, write: if isAuthenticated() && request.auth.uid == uid;
    }
    
    // Worlds collection
    match /worlds/{worldId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Monsters collection
    match /monsters/{monsterId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Items collection
    match /items/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Pets collection
    match /pets/{petId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Inventories collection
    match /inventories/{uid} {
      // User can only read/write their own inventory
      allow read, write: if isAuthenticated() && request.auth.uid == uid;
    }
    
    // Lootboxes collection
    match /lootboxes/{lootboxId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Reroll rules collection
    match /rerollRules/{ruleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Calendars collection
    match /calendars/{uid} {
      // User can only read/write their own calendar
      allow read, write: if isAuthenticated() && request.auth.uid == uid;
    }
    
    // Leaderboards collection
    match /leaderboards/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false; // No one can write to leaderboards directly
    }
    
    // Game rules collection
    match /gameRules/{ruleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Levels collection
    match /levels/{levelId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Templates collection (default player templates)
    match /templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Game configuration
    match /gameConfig/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // World configuration
    match /worldConfig/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ID generation collection (internal use only)
    match /__ids/{docId} {
      allow read: if false;
      allow write: if false;
    }
    
    // Item collections (weapons, armor, pets, accessories, arcane, misc)
    match /items_weapons/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /items_armor/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /items_pets/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /items_accessories/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /items_arcane/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /items_misc/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Courses subcollections
    match /courses/{courseId}/students/{studentId} {
      allow read: if isAuthenticated();
      allow write: if isTeacherOrAdmin();
    }
    
    match /courses/{courseId}/modules/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isTeacherOrAdmin();
      
      match /tasks/{taskId} {
        allow read: if isAuthenticated();
        allow write: if isTeacherOrAdmin();
        
        match /submissions/{submissionId} {
          // Students can read their own submissions, teachers can read all
          allow read: if isAuthenticated() && 
                        (request.auth.uid == resource.data.studentId || isTeacherOrAdmin());
          // Students can create/update their own submissions, teachers can update any
          allow create: if isAuthenticated();
          allow update: if isAuthenticated() && 
                          (request.auth.uid == resource.data.studentId || isTeacherOrAdmin());
          allow delete: if isTeacherOrAdmin();
        }
      }
    }
    
    // Default: deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
